name: ci
on: [push, pull_request]
jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'pnpm' }
      - run: corepack enable
      - run: pnpm i --frozen-lockfile
      - name: Lint
        run: pnpm -w eslint .
      - name: Unit tests
        run: pnpm -w vitest run
      - name: Anti-fabrication & no-marketing
        run: pnpm -w vitest run tools/antiFabrication.spec.ts tools/noMarketing.spec.ts
      - name: Env check
        run: node -e "require('./server/env')"
      - name: Tiny bench sample (deterministic 1-day window)
        run: |
          pnpm bench run --strategy stevie --version 1.6 \
            --symbols BTCUSDT --timeframe 5m \
            --from 2024-01-01 --to 2024-01-02 \
            --fee-bps 2 --slip-bps 1 --rng-seed 42
          test -f artifacts/latest/manifest.json
          test -f artifacts/latest/metrics.json
      - name: E2E smoke (toggle when ready)
        if: ${{ false }}
        run: pnpm -w playwright test --project=chromium --grep "@smoke"